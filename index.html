<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>答辩专用智能计时器</title>
    <!-- 引入 Tailwind CSS 样式库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 Babel (用于解析代码) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* 简单的淡入动画 */
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 图标组件 (修复版：直接渲染 SVG 并接受 props，解决大小位置问题) ---
        const Icons = {
            Play: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Pause: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>,
            RotateCcw: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></svg>,
            Settings: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Bell: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            Mic: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Clock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            Calculator: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="16" y1="18" x2="16" y2="18"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/></svg>,
            ArrowRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        };

        const Icon = ({ name, className }) => {
            const Svg = Icons[name];
            if (!Svg) return null;
            return <Svg className={className} />;
        };

        // --- 音频辅助函数 ---
        let audioCtx = null;

        const initAudio = () => {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    audioCtx = new AudioContext();
                }
            }
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        };

        const playAlertSound = (type = 'normal') => {
            if (!audioCtx) initAudio();
            if (!audioCtx) return;

            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.connect(gain);
                gain.connect(audioCtx.destination);

                const now = audioCtx.currentTime;

                // 统一温和提示音
                osc.type = 'sine';
                osc.frequency.setValueAtTime(660, now);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
                osc.start(now);
                osc.stop(now + 0.8);

            } catch (e) {
                console.error("Audio play failed", e);
            }
        };

        // --- 主组件 ---
        const DefenseTimer = () => {
            const [config, setConfig] = useState({
                presentationMin: 8,
                qaMin: 2,
                remindersInput: "3, 1",
                reminders: [3, 1]
            });

            const [mode, setMode] = useState('setup');
            const [timeLeft, setTimeLeft] = useState(0); 
            const [isActive, setIsActive] = useState(false);
            const [toast, setToast] = useState({ show: false, message: '', type: 'info' });

            const timerRef = useRef(null);
            const toastTimerRef = useRef(null);

            const handleReminderChange = (val) => {
                setConfig(prev => {
                    const nums = val.split(/[,，\s]+/).map(v => parseFloat(v)).filter(n => !isNaN(n) && n > 0).sort((a,b) => b-a);
                    return { ...prev, remindersInput: val, reminders: nums };
                });
            };

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };

            const startPresentation = () => {
                initAudio();
                setMode('presentation');
                setTimeLeft(Math.floor(config.presentationMin * 60));
                setIsActive(true);
                triggerToast(`开始汇报：限时 ${config.presentationMin} 分钟`, 'info');
                playAlertSound('normal');
            };

            const startQA = () => {
                setMode('qa');
                setTimeLeft(Math.floor(config.qaMin * 60));
                setIsActive(true);
                triggerToast(`汇报结束，进入提问：限时 ${config.qaMin} 分钟`, 'urgent'); 
                playAlertSound('normal');
            };

            const resetTimer = () => {
                setIsActive(false);
                setMode('setup');
                setToast({ show: false, message: '', type: 'info' });
                if (timerRef.current) clearInterval(timerRef.current);
            };

            useEffect(() => {
                if (isActive && timeLeft > 0) {
                    timerRef.current = setInterval(() => {
                        setTimeLeft((prev) => prev - 1);
                    }, 1000);
                } else if (timeLeft === 0 && isActive) {
                    clearInterval(timerRef.current);
                    handlePhaseEnd();
                } else {
                    clearInterval(timerRef.current);
                }
                return () => clearInterval(timerRef.current);
            }, [isActive, timeLeft, mode]);

            useEffect(() => {
                if (mode === 'presentation') {
                    const exactSeconds = timeLeft;
                    const isReminderTime = config.reminders.some(r => Math.floor(r * 60) === exactSeconds);
                    if (isReminderTime) {
                        const minLeft = (exactSeconds / 60).toFixed(0); 
                        triggerToast(`请举牌：汇报剩余 ${minLeft} 分钟`, 'urgent');
                        playAlertSound('normal');
                    }
                }
            }, [timeLeft, mode, config.reminders]);

            const handlePhaseEnd = () => {
                if (mode === 'presentation') {
                    startQA();
                } else if (mode === 'qa') {
                    triggerToast('全场答辩结束', 'urgent');
                    setIsActive(false);
                    setMode('finished');
                    playAlertSound('normal');
                }
            };

            const triggerToast = (msg, type) => {
                if (toastTimerRef.current) clearTimeout(toastTimerRef.current);
                setToast({ show: true, message: msg, type });
                toastTimerRef.current = setTimeout(() => {
                    setToast(prev => ({ ...prev, show: false }));
                }, 8000);
            };

            const closeToast = () => {
                setToast(prev => ({ ...prev, show: false }));
                if (toastTimerRef.current) clearTimeout(toastTimerRef.current);
            };

            // --- 界面渲染部分 (CSS类名保持不变) ---
            const renderSetup = () => {
                const presMin = config.presentationMin || 0;
                const qaMin = config.qaMin || 0;
                const reminders = config.reminders;
                const timelineEvents = [
                    ...reminders.map(r => ({ label: `举牌：倒数${r}分`, elapsed: presMin - r, type: 'reminder' })),
                    { label: '自动切换：进入提问', elapsed: presMin, type: 'end' }
                ].sort((a,b) => a.elapsed - b.elapsed);

                return (
                    <div className="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-lg mx-auto animate-fade-in overflow-y-auto max-h-screen my-8">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2 border-b pb-4">
                            <Icon name="Settings" className="w-6 h-6" /> 答辩参数设置
                        </h2>
                        <div className="bg-blue-50 p-4 rounded-xl mb-6 flex items-center justify-between text-blue-900">
                           <div className="flex flex-col">
                             <span className="text-xs uppercase font-bold tracking-wider opacity-70">答辩总时间</span>
                             <span className="text-2xl font-black">{presMin + qaMin} <span className="text-sm font-normal">分钟</span></span>
                           </div>
                           <div className="text-xl opacity-50"><Icon name="Calculator" className="w-8 h-8"/></div>
                        </div>
                        <div className="space-y-6">
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">汇报时间 (分钟)</label>
                                <input type="number" step="0.5" value={config.presentationMin} onChange={(e) => setConfig({...config, presentationMin: parseFloat(e.target.value) || 0})} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-lg font-mono bg-blue-50/50" />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">提问时间 (分钟)</label>
                                <input type="number" step="0.5" value={config.qaMin} onChange={(e) => setConfig({...config, qaMin: parseFloat(e.target.value) || 0})} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-lg font-mono" />
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1">汇报提醒节点 <span className="text-red-500 font-normal">(基于汇报倒计时)</span></label>
                            <input type="text" value={config.remindersInput} onChange={(e) => handleReminderChange(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-lg" placeholder="例如: 3, 1" />
                          </div>
                          <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                             <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 flex justify-between"><span>汇报进度预演</span><span>(共 {presMin} 分钟)</span></h3>
                             <div className="space-y-3 relative before:absolute before:left-[19px] before:top-2 before:bottom-2 before:w-0.5 before:bg-gray-200">
                                <div className="relative flex items-center gap-3">
                                   <div className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center z-10 border-2 border-white shadow-sm"><span className="text-xs font-bold text-green-700">0m</span></div>
                                   <div className="text-sm text-gray-600">开始汇报</div>
                                </div>
                                {timelineEvents.map((ev, idx) => (
                                    <div key={idx} className="relative flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center z-10 border-2 border-white shadow-sm ${ev.type === 'end' ? 'bg-red-100' : 'bg-blue-100'}`}><span className={`text-xs font-bold ${ev.type === 'end' ? 'text-red-700' : 'text-blue-700'}`}>{ev.elapsed}m</span></div>
                                        <div className="text-sm font-medium text-gray-800">{ev.label}{ev.elapsed < 0 ? <span className="text-red-500 text-xs ml-1">(配置错误)</span> : ''}</div>
                                    </div>
                                ))}
                             </div>
                          </div>
                          <button onClick={startPresentation} className="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl text-xl shadow-lg transition-transform active:scale-95 flex justify-center items-center gap-2"><Icon name="Play" className="w-6 h-6" /> 确认配置并开始</button>
                        </div>
                    </div>
                );
            };

            const renderTimer = () => {
                let bgClass = "bg-gray-50"; let textClass = "text-gray-900";
                if (mode === 'presentation') { bgClass = "bg-blue-50"; textClass = "text-blue-900"; }
                else if (mode === 'qa') { bgClass = "bg-orange-50"; textClass = "text-orange-900"; }

                return (
                    <div className={`flex flex-col items-center justify-center min-h-screen w-full transition-colors duration-500 ${bgClass} relative overflow-hidden`}>
                        <div className={`fixed bottom-8 right-8 z-50 transition-all duration-500 transform ${toast.show ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0 pointer-events-none'}`}>
                          <div className={`p-6 rounded-xl shadow-2xl flex items-center gap-4 max-w-md border-l-8 ${toast.type === 'urgent' ? 'bg-red-600 text-white border-red-900' : 'bg-white text-gray-800 border-blue-600'}`}>
                            {toast.type === 'urgent' ? <Icon name="AlertTriangle" className="w-10 h-10 flex-shrink-0" /> : <Icon name="Clock" className="w-10 h-10 flex-shrink-0 text-blue-600" />}
                            <div className="flex-1"><h3 className="font-bold text-lg mb-1 leading-tight">{toast.type === 'urgent' ? '请立即执行' : '流程提示'}</h3><p className="text-2xl font-black leading-tight">{toast.message}</p></div>
                            <button onClick={closeToast} className="p-2 hover:bg-black/10 rounded-full"><Icon name="X" className="w-6 h-6" /></button>
                          </div>
                        </div>
                        <div className="absolute top-0 left-0 right-0 p-6 flex justify-between items-center opacity-80">
                          <div className="flex items-center gap-3 text-xl font-bold text-gray-700">
                            {mode === 'presentation' && <><Icon name="Mic" className="w-6 h-6 text-blue-600"/> <span>汇报进行中 (共 {config.presentationMin} 分)</span></>}
                            {mode === 'qa' && <><Icon name="Bell" className="w-6 h-6 text-orange-600"/> <span>提问进行中 (共 {config.qaMin} 分)</span></>}
                            {mode === 'finished' && <><Icon name="CheckCircle" className="w-6 h-6 text-green-600"/> 已结束</>}
                          </div>
                          <button onClick={resetTimer} className="px-4 py-2 bg-white rounded-lg shadow hover:bg-gray-100 text-sm font-medium text-gray-600 flex items-center gap-2"><Icon name="RotateCcw" className="w-4 h-4" /> 重置/修改</button>
                        </div>
                        <div className="text-center w-full px-4">
                          <div className="h-16 mb-2 flex items-center justify-center">
                             {mode === 'presentation' && timeLeft > 0 && (
                                 <div className="text-gray-500 font-medium bg-white/50 px-4 py-2 rounded-full">下个提示点: {config.reminders.map(r => r * 60).filter(s => s < timeLeft).sort((a,b) => b-a)[0] ? `汇报剩余 ${(config.reminders.map(r => r * 60).filter(s => s < timeLeft).sort((a,b) => b-a)[0] / 60).toFixed(1)} 分` : '即将自动进入提问'}</div>
                             )}
                          </div>
                          <div className={`font-mono text-[22vw] md:text-[25vh] leading-none tracking-tighter tabular-nums ${textClass} drop-shadow-sm select-none`}>{formatTime(timeLeft)}</div>
                          
                          {/* 操作按钮区域 */}
                          <div className="mt-8 md:mt-12 flex justify-center gap-6 items-center">
                            {mode !== 'finished' && (
                              <button onClick={() => setIsActive(!isActive)} className="w-20 h-20 md:w-24 md:h-24 rounded-full bg-white shadow-xl flex items-center justify-center hover:bg-gray-50 transition active:scale-95">
                                {isActive ? <Icon name="Pause" className="w-8 h-8 md:w-10 md:h-10 text-gray-800" /> : <Icon name="Play" className="w-8 h-8 md:w-10 md:h-10 text-green-600 ml-1" />}
                              </button>
                            )}
                            
                            {/* 新增：提前进入提问 (仅 presentation) */}
                            {mode === 'presentation' && (
                                <button onClick={startQA} className="px-6 py-4 bg-orange-100 hover:bg-orange-200 text-orange-800 rounded-xl text-lg font-bold transition-colors flex flex-col items-center justify-center leading-tight shadow-sm hover:shadow-md">
                                    <span className="text-xs font-normal opacity-70 mb-0.5">汇报结束</span>
                                    <div className="flex items-center gap-1">
                                        <span>进入提问</span>
                                        <Icon name="ArrowRight" className="w-4 h-4" />
                                    </div>
                                </button>
                            )}
                            
                            {/* 提前结束 (仅 qa) */}
                            {mode === 'qa' && (
                               <button onClick={() => { setTimeLeft(0); handlePhaseEnd(); }} className="px-6 py-4 bg-gray-200 hover:bg-red-100 text-gray-700 hover:text-red-600 rounded-xl text-lg font-bold transition-colors">提前结束</button>
                            )}
                          </div>
                        </div>
                    </div>
                );
            };

            const renderFinished = () => (
                <div className="flex flex-col items-center justify-center min-h-screen bg-green-50">
                  <div className="bg-white p-12 rounded-3xl shadow-2xl text-center max-w-md w-full">
                    <Icon name="CheckCircle" className="w-24 h-24 text-green-500 mx-auto mb-6" />
                    <h1 className="text-4xl font-bold text-gray-800 mb-2">答辩结束</h1>
                    <p className="text-gray-500 text-lg mb-8">所有流程已完成</p>
                    <button onClick={resetTimer} className="w-full py-4 bg-green-600 text-white rounded-xl hover:bg-green-700 transition font-bold text-xl shadow-lg">开始下一位</button>
                  </div>
                </div>
            );

            return (
                <div className="font-sans h-screen w-screen overflow-hidden bg-gray-50">
                  {mode === 'setup' && <div className="h-full flex items-center justify-center p-4 bg-gray-100 overflow-y-auto">{renderSetup()}</div>}
                  {(mode === 'presentation' || mode === 'qa') && renderTimer()}
                  {mode === 'finished' && renderFinished()}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DefenseTimer />);
    </script>
</body>
</html>